---
    title: 总线控制
    date: 2022-08-29 23:02:22 
---

# 总线控制

## 一、总线判优控制

### 1. 基本概念

- 主设备(模块) 可以提出总线占用请求，控制和其他设备之间的通信过程 对总线有 控制权（有些总线可以由多个主设备）
- 从设备(模块) 响应 从主设备发来的总线命令
- 总线判优控制：集中式(总线控制部件集中在一起)，分布式
  - 集中式：链式查询，计数器定时查询，独立请求方式
  - 分布式

### 2. 链式查询方式



![img](http://toomson.com:81/images/image-20220504174743895.png)



数据总线：用于信息交换过程中数据传输

地址总线：主设备占用总线之后，和从设备进行数据传输通过地址总线找到从设备

BR：所有设备都通过BR发起总线占用请求

BS：如果有设备占用总线，就通过BS告诉其他设备总线忙

BG：总线授权线，一个一个向下查询（链式查询）

- I/O接口（外设）有占用请求时，通过BR给总线控制部件发送占用请求
- 总线控制部件接受到请求以后且可以让出总线的控制权（BS总线不忙）时，通过BG总线授权信号逐个进行查询是哪个I/O接口（设备）发出的请求
- 总线授权信号碰到第一个提出总线占用请求的接口，则它就获得了总线的使用权，并且通过BS设置总线忙

链式查询

**缺点**：优先级事先已经确定的，优先级太低的可能一直得不到总线授权。对电路故障特别敏感，如果BG上的某接口出现电路故障，信号不会往下传，后面的设备永远无法获得使用权，速度慢

**优点**：结构简单，优先级算法简单，增删设备简单，进行可靠性设计时容易实现

一般运用在微型计算机，简单的嵌入式系统中

### 3. 计数器定时查询方式



![img](http://toomson.com:81/images/image-20220504174813034.png)



BG线变成了设备地址线（宽度和设备地址有关）

- I/O接口（外设）有占用请求时，通过BR给总线控制部件发送占用请求
- 总线控制部件接受到请求以后且可以让出总线的控制权（BS总线不忙）时，启动总线控制部件中的计数器，计数器的值通过设备地址这条线向外输出查询接口
- 计数器根据计数器的值访问对应I/O接口，如果不是就加一，继续访问，直到碰到第一个提出总线占用请求的接口，则它就获得了总线的使用权，并且通过BS设置总线忙

**缺点**：比链式查询需要的线多，log2n向上取整+2条线，速度慢

**优点**：优先级确定非常灵活，如：每次从0或K开始一直到n，则0或k接口优先级最高，如：每次从上一次数值开始变成循环优先级等等。

### 4. 独立请求方式



![img](http://toomson.com:81/images/image-20220504175225883.png)



每个接口都有自己的BR，BG线

优先级由总线控制部件内部的排队器决定

- I/O接口（外设）有占用请求时，通过自己的BR给总线控制部件发送占用请求
- 总线控制部件接受到请求以后且可以让出总线的控制权（BS总线不忙）时，经过排队其排队以后，对某一个（根据优先级）提出总线控制请求的设备进行总线授权
- 获得总线控制部件应答的设备，就占用了总线的使用权

**优点**：优先级确定非常灵活，自定义排队器

**缺点**：需要的线多2n条线

## 二、总线通信控制

### 1. 目的： 解决通信双方协调配合问题

### 2. 总线传输周期

- 申请分配阶段： 主模块申请，总线仲裁决定（总线判优逻辑：上面所解决的问题）
- 寻址阶段： 主模块（向从模块）给出地址（找到从设备） 和 命令（控制从设备完成相应的操作）
- 传数阶段： 主模块和从模块交换数据
- 结束阶段： 主模块和从模块都撤消有关信息

### 3. 总线通信的四种方式

- 同步通信：由统一时标控制数据传送 **应用在总线长度比较短且各个模块存取时间比较一致的情况下**
- 异步通信：采用应答方式 ，没有公共时钟标准
- 半同步通信： 同步、异步结合
- 分离式通信： 充分挖掘系统总线每个瞬间的潜力

------

#### 同步通信：由统一时标控制数据传送(主从模块是强制同步的，速度不同模块需要选择速度最慢的模块作为统一的时标)

CPU用同步通信的方式从外部设备进行数据输入

同步通讯有定宽定距的时标来控制整个数据的传输过程

时钟信号：总线传输周期由四个时钟周期构成，这四个时钟周期就可以完成一次完整可靠的数据通信

CPU完成数据输入需要地址信号，读信号，从设备在给定的时间点上给出数据的输出，对CPU来说时数据的输入

**在固定的时间点上要给出固定的操作：**

- T1时钟周期的上升沿CPU（主设备）必须给出地址信号，
- T2时钟周期的上升沿必须给出读命令信号告诉从设备CPU（主设备）要从从模块读入数据
- T3时钟周期的上升沿到达之前从设备必须通过数据总线给出数据信号
- T4时钟周期的上升沿数据信号和读信号（控制信号）可以撤销，T4结束时地址信号也撤销



![img](http://toomson.com:81/images/image-20220504192233922.png)



CPU用同步通信的方式把数据输出到外部设备

同步通讯有定宽定距的时标来控制整个数据的传输过程

时钟信号：总线传输周期由四个时钟周期构成，这四个时钟周期就可以完成一次完整可靠的数据通信

CPU完成数据输入需要地址信号，写信号

**在固定的时间点上要给出固定的操作：**

- T1时钟周期的上升沿CPU（主设备）必须给出地址信号，
- T1时钟周期的下降沿给出数据
- T2时钟周期的上升沿必须给出写命令信号 向从设备进行数据写入
- T4时钟周期的上升沿数据信号和写信号（控制信号）可以撤销，T4结束时地址信号也撤销



![img](http://toomson.com:81/images/image-20220504192257624.png)



#### 异步通信： 采用应答方式，没有公共时钟标准

主设备发起请求，从设备受主设备控制，不用定宽定距的时钟



![img](http://toomson.com:81/images/image-20220504192313295.png)



- **异步通信不互锁方式（通信没有可靠性）：**主设备发起通信请求，从设备接受到主设备请求发出应答信号，主设备撤销请求信号，从设备撤销应答信号，主设备不管有没有收到应答信号，一定延时后都会撤销请求信号，从设备不管主设备有没有接到应答信号，一定延时后都会撤销应答信号
- **异步通信半互锁方式（可能造成主设备请求信号一直保持高电平）：**主设备发起通信请求，从设备接受到主设备请求发出应答信号，主设备接收到应答信号以后撤销请求信号，如果接收不到，请求信号会保持，从设备不管主设备有没有接到应答信号，一定延时后都会撤销应答信号
- **异步通信全互锁方式（通过握手信号完成可靠的数据传输通信联络）：**主设备发起通信请求，从设备接受到主设备请求发出应答信号，主设备接收到应答信号以后撤销请求信号，如果接收不到，请求信号会保持，只有主设备的请求信号撤销以后，从设备才会撤销自己的应答信号

#### 半同步通信： 同步、异步结合

- 同步： 发送方 用系统 时钟前沿 发信号

  接收方 用系统 时钟后沿 判断、识别

- 异步 允许不同速度的模块和谐工作 增加一条 “等待”响应信号 WAIT

以输入数据为例的半同步通信时序（主模块熟读快，等从模块回应）

T1 主模块发地址

T2 主模块发命令

Tw 当 WAIT为低电平时，等待一个 T

Tw 当 WAIT为低电平时，等待一个 T

…

T3 从模块提供数据

T4 从模块撤销数据，主模块撤销命令

- T1时钟周期的上升沿CPU（主设备）必须给出地址信号，
- T2时钟周期的上升沿必须给出读命令信号告诉从设备CPU（主设备）要从从模块读入数据
- T3时钟周期开始之前，从设备如果不能把数据准备好，通过WAIT信号给出低电平，告诉主设备进行等待，CPU会在第三个时钟周期到来之前插入一个时钟周期Tw（循环往复）
- 数据已经准备好放在数据总线上，WAIT变成高电平时，则该Tw结束后开始T3周期
- T4时钟周期的上升沿数据信号和读信号（控制信号）可以撤销，T4结束时地址信号也撤销



![img](http://toomson.com:81/images/image-20220504192531533.png)



#### 上述三种通信的共同点

一个总线传输周期（以输入数据为例）

- 主模块发地址 、命令： 占用总线
- 从模块准备数据： 不占用总线 总线空闲
- 从模块向主模块发数据： 占用总线

总线有空闲

#### 分离式通信 充分挖掘系统总线每个瞬间的潜力

一个总线传输周期，子周期1和2之间用来让从模块准备数据，子周期2中从模块已经变成了主模块



![img](http://toomson.com:81/images/image-20220504192742183.png)



**读数据时，准备数据 硬盘有三步操作：**

主模块向从模块发出找指定磁道请求后，放弃总线使用权

1. 定位：磁头镜像移动，寻找指定磁道（时间长）

硬盘找到指定磁道变成主模块，发出找对应扇区的请求后，放弃总线使用权

1. 找到指定扇区：磁头停止在磁盘表面不动，磁盘围绕轴转动（时间长）

硬盘找到指定扇区变成主模块，发出读请求，进行数据传输

1. 读数据

- 分离式通信特点（充分提高了总线的有效占用）

1. 各模块有权申请占用总线
2. 采用同步方式通信，不等对方回答
3. 各模块准备数据时，不占用总线
4. 总线被占用时，无空闲